<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Authentication Required</title>
    <script src="nr_websocket.js"></script>
    <script src="nr_rover_control.js"></script>
    <script src="nr_gamepad.js"></script>
</head>
<body>
    <div id="document-body">

    <script>

        function parseMyXml(xmlStr) {
            return new window.DOMParser().parseFromString(xmlStr, "text/xml");
        }

        var xhr = null;
        var indexPageRequest = null;

        function onAuthReponse() {
            console.log('xhr onAuthReponse');
            
            if(xhr == null) {
                // The server returned an empty string; this means that the authentication failed.
                console.log('null xhr');
                window.location = "auth_failed.html";
            }

            if(xhr.responseText) {
                console.log('xhr.responseText:'+xhr.responseText);
            }

            if(xhr.responseText.length == 0) {
                console.log('zero length response text');
                window.location = "auth_failed.html";
            }

            // Storing session ID in response header somehow caused invalid response header
            // and couldn't find a way to resolve the problem so decided not to use this.
            // let sessionId = xhr.getResponseHeader('Nyanko-Rover-Session-ID');
            // if(sessionId == null) {
            //     alert('server did not return a session id');
            //     window.location = "auth_failed.html";
            // }

            console.log('xhr response text: '+xhr.responseText);

            var sidXml = parseMyXml(xhr.responseText);
            nodes = sidXml.getElementsByTagName('sid');
            if(nodes.length == 0) {
                console.log('sid node not detected.');
                window.location = "auth_failed.html";
            }
            let sessionId = nodes[0].innerHTML;

            console.log('session ID: '+sessionId);
            //alert(xhr.responseText);

            sessionStorage.setItem('nrsid',sessionId);

            indexPageRequest = new XMLHttpRequest();
            indexPageRequest.onload = function() {
                //alert("The page should transition to home.");
                //document.getElementsByTagName("title")[0].innerHTML = 'Rover Control';
                document.getElementById('document-body').innerHTML = indexPageRequest.responseText;
            };
            indexPageRequest.open("GET","/index.html");
            indexPageRequest.setRequestHeader('nrsid',sessionId); // do_GET of the server checks the sid.
            console.log('About to send a GET request.');
            indexPageRequest.send();
            console.log('GET request sent.');
        }

        let auth_result = "";
        let numRetries = 3;
        //while(true) {
            var entered_text = prompt('Enter PIN to proceed',"");
            console.log('entered text: '+entered_text)
            var xhr = new XMLHttpRequest();
            xhr.onload = onAuthReponse;
            xhr.open("GET","auth");
            xhr.setRequestHeader('my-password',entered_text);
            console.log('sending xhr');
            xhr.send();
        //}

    </script>
    </div>
</body>
</html>
