<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Authentication Required</title>
</head>
<body>
    <p id="meow">The Nyanko - Season 10</p>
    <script>

        function parseMyXml(xmlStr) {
            return new window.DOMParser().parseFromString(xmlStr, "text/xml");
        }

        var xhr = null;
        var indexPageRequest = null;

        function onAuthReponse() {
            console.log('xhr onAuthReponse');
            
            if(xhr == null) {
                // The server returned an empty string; this means that the authentication failed.
                alert('null xhr');
                window.location = "auth_failed.html";
            }

            if(xhr.responseText) {
                alert('xhr.responseText:'+xhr.responseText);
            }

            // let sessionId = xhr.getResponseHeader('Nyanko-Rover-Session-ID');
            // if(sessionId == null) {
            //     alert('server did not return a session id');
            //     window.location = "auth_failed.html";
            // }

            var sidXml = parseMyXml(xhr.responseText);
            nodes = sidXml.getElementsByTagName('sid');
            if(nodes.length == 0) {
                alert('sid node not detected.')
            }
            let sessionId = nodes[0].innerHTML;

            console.log('xhr response text: '+xhr.responseText);
            console.log('session ID: '+sessionId);
            //alert(xhr.responseText);

            sessionStorage.setItem('nrsid',sessionId);

            indexPageRequest = new XMLHttpRequest();
            indexPageRequest.onload = function() {alert("The page should transition to home.");};
            indexPageRequest.open("GET","/index.html");
            indexPageRequest.setRequestHeader('nrsid',sessionId); // do_GET of the server checks the sid.
            alert('About to send a GET request.');
            indexPageRequest.send();

            alert('GET request sent.');
        }

        var t = "";
        let auth_result = "";
        //while(t != "abc") {
            var entered_text = prompt('Enter PIN to proceed',"");
            alert('entered text: '+entered_text)
            var xhr = new XMLHttpRequest();
            xhr.onload = onAuthReponse;
            xhr.open("GET","auth");
            xhr.setRequestHeader('my-password',entered_text);
            console.log('sending xhr');
            xhr.send();

            //t = entered_text;
        //}


        // if(auth_result == "success") {
        //     // Go to the page the user requested
        //     window.location = "/index.html";
        //     alert("auth successful");
        // }
        // else {
        //     //
        //     alert("auth failed");
        // }
    </script>
</body>
</html>
